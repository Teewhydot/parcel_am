import 'package:flutter/material.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import 'package:food/food/components/buttons.dart';
import 'package:food/food/components/image.dart';
import 'package:food/food/components/scaffold.dart';
import 'package:food/food/core/constants/app_constants.dart';
import 'package:food/food/core/theme/colors.dart';
import 'package:food/food/features/home/presentation/widgets/circle_widget.dart';
import 'package:food/generated/assets.dart';
import 'package:get/get.dart';
import 'package:get_it/get_it.dart';
import 'dart:async';
import 'package:dartz/dartz.dart' hide State;

import '../../../../../core/routes/routes.dart';
import '../../../../../core/services/navigation_service/nav_config.dart';
import '../../../../../components/texts.dart';
import '../manager/paystack_bloc/paystack_payment_bloc.dart';
import '../manager/paystack_bloc/paystack_payment_event.dart';
import '../manager/paystack_bloc/paystack_payment_state.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../../../../domain/failures/failures.dart';
import '../../../../auth/data/remote/data_sources/user_data_source.dart';
import '../../../travellink/presentation/bloc/parcel/parcel_bloc.dart';
import '../../../travellink/presentation/bloc/parcel/parcel_event.dart';

enum PaymentStatusEnum { success, failure, pending }

class PaymentStatus extends StatefulWidget {
  final PaymentStatusEnum? status;
  final String? orderId;
  final String? reference;
  final String? paymentMethod;
  final String? parcelId;

  const PaymentStatus({
    super.key,
    this.status,
    this.orderId,
    this.reference,
    this.paymentMethod,
    this.parcelId,
  });

  @override
  State<PaymentStatus> createState() => _PaymentStatusState();
}

class _PaymentStatusState extends State<PaymentStatus> {
  PaymentStatusEnum _currentStatus = PaymentStatusEnum.pending;
  bool _isMonitoring = false;
  String _statusMessage = 'Checking payment status...';
  final nav = GetIt.instance<NavigationService>();
  final userDataSource = GetIt.instance<UserDataSource>();

  @override
  void initState() {
    super.initState();
    _initializeStatus();
  }

  @override
  void dispose() {
    super.dispose();
  }

  void _initializeStatus() {
    if (widget.status != null) {
      // Static status mode
      _currentStatus = widget.status!;
      _statusMessage = _getStatusMessage(_currentStatus);
    } else if (widget.reference != null) {
      // Payment verification mode
      _isMonitoring = true;
      _verifyPaymentStatus();
    }
  }

  void _verifyPaymentStatus() async {
    if (widget.reference == null) return;

    setState(() {
      _statusMessage = 'Verifying payment...';
    });

    // Verify payment using the BLoC
    context.read<PaystackPaymentBloc>().add(
      VerifyPaystackPaymentEvent(
        reference: widget.reference!,
        orderId: widget.orderId ?? '',
      ),
    );
  }


  String _getStatusMessage(PaymentStatusEnum status) {
    switch (status) {
      case PaymentStatusEnum.success:
        return 'Thank you for your purchase!';
      case PaymentStatusEnum.failure:
        return 'Something went wrong, please try again.';
      case PaymentStatusEnum.pending:
        return 'Processing your payment...';
    }
  }

  @override
  Widget build(BuildContext context) {
    return BlocListener<PaystackPaymentBloc, PaystackPaymentState>(
      listener: (context, state) {
        if (state is PaystackPaymentVerified) {
          setState(() {
            if (state.transaction.isSuccess) {
              _currentStatus = PaymentStatusEnum.success;
              _statusMessage = 'Payment successful!';

              // Update parcel status to paid if parcelId is provided
              if (widget.parcelId != null && widget.parcelId!.isNotEmpty) {
                try {
                  context.read<ParcelBloc>().add(
                    ParcelPaymentCompleted(
                      parcelId: widget.parcelId!,
                      transactionId: state.transaction.reference,
                    ),
                  );
                } catch (e) {
                  // ParcelBloc might not be available if not navigated from parcel flow
                  // This is okay - payment was still successful
                }
              }
            } else {
              _currentStatus = PaymentStatusEnum.failure;
              _statusMessage = 'Payment verification failed. Please contact support.';
            }
          });
        } else if (state is PaystackPaymentError) {
          setState(() {
            _currentStatus = PaymentStatusEnum.failure;
            _statusMessage = state.message;
          });
        }
      },
      child: FScaffold(
      appBarWidget: _isMonitoring
          ? AppBar(
              title: FText(
                text: 'Payment Status',
                fontSize: 18,
                fontWeight: FontWeight.w600,
              ),
              backgroundColor: kWhiteColor,
              elevation: 0,
              automaticallyImplyLeading: false,
              actions: [
                TextButton(
                  onPressed: () => nav.navigateAndOffAll(Routes.home, Routes.statusScreen),
                  child: const FText(
                    text: 'Home',
                    color: kPrimaryColor,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ],
            )
          : Container(),
      body: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Column(
            children: [
              _isMonitoring ? 100.verticalSpace : 238.verticalSpace,

              // Status icon/animation
              if (_currentStatus == PaymentStatusEnum.success)
                FImage(
                  assetPath: Assets.svgsSuccessful,
                  width: 260,
                  height: 181,
                  assetType: FoodAssetType.svg,
                )
              else if (_currentStatus == PaymentStatusEnum.failure)
                CircleWidget(
                  color: kErrorColor,
                  radius: 60,
                  child: const Icon(Icons.close, size: 90, color: kWhiteColor),
                )
              else
                // Pending status - show loading
                Column(
                  children: [
                    const CircularProgressIndicator(
                      color: kPrimaryColor,
                      strokeWidth: 3,
                    ),
                    16.verticalSpace,
                    const FText(
                      text: 'Processing...',
                      fontSize: 16,
                      color: kGreyColor,
                    ),
                  ],
                ),

              32.verticalSpace,

              // Status title
              FText(
                text: _getStatusTitle(_currentStatus),
                fontSize: 24,
                fontWeight: FontWeight.bold,
                textAlign: TextAlign.center,
              ),

              16.verticalSpace,

              // Status message
              FText(
                text: _statusMessage,
                fontSize: 16,
                color: kGreyColor,
                textAlign: TextAlign.center,
              ),

              // Real-time monitoring indicator
              if (_isMonitoring && _currentStatus == PaymentStatusEnum.pending) ...[
                24.verticalSpace,
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Container(
                      width: 8,
                      height: 8,
                      decoration: const BoxDecoration(
                        color: kPrimaryColor,
                        shape: BoxShape.circle,
                      ),
                    ),
                    8.horizontalSpace,
                    const FText(
                      text: 'Monitoring payment status...',
                      fontSize: 12,
                      color: kPrimaryColor,
                    ),
                  ],
                ),
              ],
            ],
          ),

          const Spacer(),

          // Action buttons
          Column(
            children: [
              FButton(
                buttonText: _getButtonText(_currentStatus),
                width: 1.sw,
                color: _currentStatus == PaymentStatusEnum.failure
                    ? kErrorColor
                    : kPrimaryColor,
                onPressed: () => _handleButtonPress(),
              ),

              // Additional "Go Home" button if monitoring and not failed
              if (_isMonitoring && _currentStatus != PaymentStatusEnum.failure) ...[
                12.verticalSpace,
                FButton(
                  buttonText: "Go to Home",
                  width: 1.sw,
                  color: kGreyColor,
                  onPressed: () => nav.navigateAndOffAll(Routes.home, Routes.statusScreen),
                ),
              ],
            ],
          ),
        ],
      ).paddingAll(AppConstants.defaultPadding),
      ),
    );
  }

  String _getStatusTitle(PaymentStatusEnum status) {
    switch (status) {
      case PaymentStatusEnum.success:
        return 'Payment Successful!';
      case PaymentStatusEnum.failure:
        return 'Payment Failed';
      case PaymentStatusEnum.pending:
        return 'Processing Payment';
    }
  }

  String _getButtonText(PaymentStatusEnum status) {
    switch (status) {
      case PaymentStatusEnum.success:
        return "Go to Home";
      case PaymentStatusEnum.failure:
        return "Retry Payment";
      case PaymentStatusEnum.pending:
        return "Verify Again";

    }
  }

  void _handleButtonPress() {
    switch (_currentStatus) {
      case PaymentStatusEnum.success:
        nav.navigateAndOffAll(Routes.home, Routes.statusScreen);
        break;
      case PaymentStatusEnum.failure:
        nav.goBack();
        break;
      case PaymentStatusEnum.pending:
        // For pending, try to verify again
        if (widget.reference != null) {
          _verifyPaymentStatus();
        }
        break;
    }
  }
}
